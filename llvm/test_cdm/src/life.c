#define N 32
#define VRAM (((volatile char(*)[32])(0xF800)))
#define BTN ((volatile int*) (0xFC00))

//#define LIFE_1
//#define LIFE_2
#define LIFE_3

// #define EDIT

#ifdef LIFE_1
void life(char src[N][N], char dst[N][N]){
  for(int y = 0; y < N; y++){
    VRAM[y][31] = 2;
    for(int x = 0; x < N; x++){
      int ns = 0;
      if(y < (N-1)) ns += src[y+1][x];
      if(x < (N-1)) ns += src[y][x+1];
      if(y > 0) ns += src[y-1][x];
      if(x > 0) ns += src[y][x-1];
      if(y < (N-1) && x < (N-1)) ns += src[y+1][x+1];
      if(y < (N-1) && x > 0) ns += src[y+1][x-1];
      if(y > 0 && x > 0) ns += src[y-1][x-1];
      if(y > 0 && x < (N-1)) ns += src[y-1][x+1];

      if(!src[y][x] && ns == 3)dst[y][x] = 1;
      else if ((ns == 2 || ns == 3) && src[y][x]) dst[y][x] = 1;
      else dst[y][x] = 0;
    }
  }
}
#endif

#ifdef EDIT
int get_btn(){
  while (*BTN){}
  int res = 0;
  while (!(res = *BTN)){}
  return res;
}
#endif

#ifdef LIFE_2
void life(char src[N][N], char dst[N][N]){
  for(int y = 0; y < N; y++){
    VRAM[y][31] = 2;
    for(int x = 0; x < N; x++){
      int ns = 0;
      if(y < (N-1)){
        ns += src[y+1][x];
        if(x < (N-1))ns += src[y+1][x+1];
        if(x > 0) ns += src[y+1][x-1];
      }
      if(y > 0){
        ns += src[y-1][x];
        if(x > 0) ns += src[y-1][x-1];
        if(x < (N-1)) ns += src[y-1][x+1];
      }
      if(x < (N-1)) ns += src[y][x+1];
      if(x > 0) ns += src[y][x-1];

      if(!src[y][x] && ns == 3)dst[y][x] = 1;
      else if ((ns == 2 || ns == 3) && src[y][x]) dst[y][x] = 1;
      else dst[y][x] = 0;
    }
  }
}
#endif

#ifdef LIFE_3
// TODO: this compiles incorrectly
//__attribute__((noinline))
static void life(char src[N][N], char dst[N][N]){
  for(int y = 1; y < (N-1); y++){
    for(int x = 1; x < (N-1); x++){
      VRAM[y][31] = 2;
      int ns = 0;
      ns += src[y+1][x];
      ns += src[y][x+1];
      ns += src[y-1][x];
      ns += src[y][x-1];
      ns += src[y+1][x+1];
      ns += src[y+1][x-1];
      ns += src[y-1][x-1];
      ns += src[y-1][x+1];

      if(!src[y][x] && ns == 3)dst[y][x] = 1;
      else if ((ns == 2 || ns == 3) && src[y][x]) dst[y][x] = 1;
      else dst[y][x] = 0;
      //      dst[y][x]=src[y][x];
    }
  }
}
#endif

// TODO: static s and life cause weird bugs
#ifndef EDIT
char s[N][N] = {
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
    {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, },
};
#else
char s[N][N];
#endif
char d[N][N];

#ifdef EDIT
static void edit(){
  int x = 0;
  int y = 0;
  int prevX = 0;
  int prevY = 0;
  VRAM[y][x] = 2 | s[y][x];
  while (1){
    int b = get_btn();
    switch (b) {
    case 1:
      x++;
      break;
    case 2:
      y++;
      break;
    case 4:
      x--;
      break;
    case 8:
      y--;
      break;
    case 16:
      s[y][x] = s[y][x] ^ 1;
      break;
    default:
      return;
    }
    VRAM[prevY][prevX] = s[prevY][prevX];
    prevY = y;
    prevX = x;
    VRAM[y][x] = 2 | s[y][x];
  }
}
#endif
//__attribute__((noinline))
static void display(char data[N][N]){
  for(int i = 0; i < N; i++){
    for(int j = 0; j < N; j++){
      VRAM[i][j] = data[i][j];
    }
  }
}



int main(){
#ifdef EDIT
  edit();
#endif
  while (1){
    display(s);
    life(s, d);
    display(d);
    life(d, s);
  }
  return 0;
}